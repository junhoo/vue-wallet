<template>
  <div>
    <button @click='send'>发消息</button>
  </div>
</template>

<script>
export default {
  name: 'Socket',
  data () {
    return {
      path: 'ws://192.168.1.249:9508',
      socket: '',
      randomStr: ''
    }
  },
  // props: {
  //   url: ''
  // },
  mounted () {
    console.log('socket-mounted')
    // 初始化
    this.init()
  },
  methods: {
    init () {
      if (typeof (WebSocket) === 'undefined') {
        console.log('当天环境不支持socket')
      } else {
        // 实例化socket
        this.socket = new WebSocket(this.path)
        // 监听socket连接
        this.socket.onopen = this.open
        // 监听socket错误信息
        this.socket.onerror = this.error
        // 监听socket消息
        this.socket.onmessage = this.getMessage
      }
    },
    open () {
      console.log('socket连接成功')
      this.randomStr = Math.random().toString(36).substr(2)
      const data = {
        'from_uid': 123, // 用户id
        'to_uid': 10000, // 接收id
        'type': 101, // 类型
        'rand_str': this.randomStr,
        'msg': {
          'device': 'android 6.7.8.9' // 设备号
        }
      }
      this.send(JSON.stringify(data))
    },
    error () {
      console.log('连接错误')
    },
    getMessage (msg) {
      console.log('socket接收')
      let res = msg.data
      try {
        res = JSON.parse(res)
      } catch (error) {
        console.log('socket接收-解析失败')
      }
      console.log(res.from_uid, 10000)
      console.log(this.randomStr, res.rand_str)
      if (res.from_uid === 10000 && this.randomStr === res.rand_str) {
        console.log('ok')
      }
    },
    send (params) {
      console.log('socket发送')
      console.log(params)
      this.socket.send(params)
    },
    close () {
      console.log('socket已经关闭')
    }
  },
  destroyed () {
    // 销毁监听
    this.socket.onclose = this.close
  }
}
</script>
